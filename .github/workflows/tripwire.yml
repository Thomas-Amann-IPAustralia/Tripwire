name: Tripwire Check

on:
  schedule:
    # Run every 6 hours (00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  
  # Allow manual trigger from the "Actions" tab
  workflow_dispatch:

# Permission to write to the repository is required to save the SQLite DB
permissions:
  contents: write

jobs:
  run-tripwire:
    runs-on: ubuntu-latest

    steps:
      # 1. Get the repository code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Prepare Python environment
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 3. Install requirements
      - name: Install Dependencies
        run: pip install -r requirements.txt

      # 4. Execute the Tripwire Logic
      - name: Run Tripwire Script
        run: python tripwire.py

      # 5. Commit changes IF the database was updated
      - name: Commit and Push Changes
        run: |
          git config --global user.name "Tripwire Bot"
          git config --global user.email "actions@github.com"
          
          # Check if tripwire_history.json has been modified or created
          if [[ -n $(git status --porcelain tripwire_history.json) ]]; then
            echo "Changes detected in history file. Committing..."
            git add tripwire_history.json
            git commit -m "Tripwire: Update source history [skip ci]"
            git push
          else
            echo "No changes to history."
          fi
