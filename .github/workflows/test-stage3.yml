name: Test Stage 3 (Phase 3 - With Tests)

on:
  workflow_dispatch:
    inputs:
      run_manual_test:
        description: 'Also run manual test on a real diff file?'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  test-stage3:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Verify API Key via Curl
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          curl https://api.openai.com/v1/models \
            -H "Authorization: Bearer $OPENAI_API_KEY"

      - name: Generate Mock Semantic Data
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "=== Generating mock semantic embeddings ==="
          python generate_mock_data.py

      - name: Run Pytest Test Suite
        env:
            OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "=== Running pytest test suite ==="
          pytest test_stage3.py -v --tb=short

      - name: Manual Test on Real Diff (Optional)
        if: ${{ github.event.inputs.run_manual_test == 'true' }}
        run: |
          echo "=== Testing with real diff file ==="
          DIFF_FILE="diff_archive/20260216_184111_IP_Australia_What_are_trade_marks_.diff"
          if [ -f "$DIFF_FILE" ]; then
            echo "Testing with: $DIFF_FILE"
            python tripwire.py --test-stage3 "$DIFF_FILE"
          else
            echo "Specified diff file not found. Skipping."
          fi

      - name: Summary
        if: success()
        run: |
          echo "âœ“ Phase 3 Testing Complete!"
