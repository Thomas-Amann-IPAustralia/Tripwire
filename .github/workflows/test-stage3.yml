name: Test Stage 3 (Phase 2 - With Tests)

on:
  workflow_dispatch:
    inputs:
      run_manual_test:
        description: 'Also run manual test on a real diff file?'
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  test-stage3:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Verify API Key via Curl
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          curl https://api.openai.com/v1/models \
            -H "Authorization: Bearer $OPENAI_API_KEY"

      - name: Generate Mock Semantic Data
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "=== Generating mock semantic embeddings ==="
          python generate_mock_data.py

      - name: Run Pytest Test Suite
        env:
            OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "=== Running pytest test suite ==="
          pytest test_stage3.py -v --tb=short

      - name: Manual Test on Real Diff (Optional)
        if: ${{ github.event.inputs.run_manual_test == 'true' }}
        run: |
          echo "=== Testing with real diff file ==="
          if ls diff_archive/*.diff 1> /dev/null 2>&1; then
            FIRST_DIFF=$(ls diff_archive/*.diff | head -n 1)
            echo "Testing with: $FIRST_DIFF"
            python tripwire.py --test-stage3 "$FIRST_DIFF"
          else
            echo "No diff files found. Skipping manual test."
          fi

      - name: Summary
        if: success()
        run: |
          echo "✓ Phase 2 Testing Complete!"
          echo ""
          echo "All tests passed. Stage 3 Phase 2 implementation verified:"
          echo "  - Diff parsing ✓"
          echo "  - Power word detection ✓"
          echo "  - Semantic embedding ✓"
          echo "  - Scoring logic ✓"
          echo "  - Threshold filtering ✓"
          echo ""
          echo "Next: Phase 3 - Load Tom's spreadsheet and generate handover packets"
